<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indikator Graf - Detaljerad Analys</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        header h1 {
            font-size: 2rem;
            color: #333;
            margin-bottom: 10px;
        }

        header h2 {
            font-size: 1.2rem;
            color: #666;
        }

        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 30px;
        }

        .info-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-item strong {
            display: block;
            color: #667eea;
            margin-bottom: 5px;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
        }

        .close-btn:hover {
            background: #d32f2f;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #c62828;
        }

        .data-source {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .data-source p {
            color: #999;
            font-size: 0.85rem;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="close-btn" onclick="window.close()">St칛ng</button>
        <header>
            <h1 id="indicatorTitle">游늳 Indikator Analys</h1>
            <h2 id="stockName">Laddar...</h2>
        </header>

        <div id="error" class="error hidden"></div>

        <div id="chart-section">
            <div class="chart-container">
                <canvas id="indicatorChart"></canvas>
            </div>

            <div class="info-section">
                <h3 id="infoTitle">Om Indikatorn</h3>
                <div class="info-grid" id="infoGrid">
                </div>
            </div>

            <footer class="data-source">
                <p>Datak칛lla: Yahoo Finance</p>
            </footer>
        </div>
    </div>

    <script>
        // Indicator information
        const indicatorInfo = {
            MA: {
                title: 'Glidande Medelv칛rde (MA)',
                info: [
                    { title: 'Vad 칛r MA?', desc: 'Ett glidande medelv칛rde j칛mnar ut prisfluktuationer och visar trendens riktning' },
                    { title: 'K칬psignal', desc: 'N칛r priset bryter 칬ver MA-linjen indikerar det en upp친tg친ende trend' },
                    { title: 'S칛ljsignal', desc: 'N칛r priset bryter under MA-linjen indikerar det en ned친tg친ende trend' },
                    { title: 'Period', desc: 'L칛ngre perioder (200 dagar) ger mer stabila signaler' },
                    { title: 'Anv칛ndning', desc: 'Anv칛nds f칬r att identifiera trendf칬r칛ndringar och support/resistance-niv친er' },
                    { title: 'Tips', desc: 'Kombinera med andra indikatorer f칬r b칛ttre noggrannhet' }
                ]
            },
            EMA: {
                title: 'Exponentiellt Medelv칛rde (EMA)',
                info: [
                    { title: 'Vad 칛r EMA?', desc: 'Liknande MA men ger mer vikt 친t senaste priserna' },
                    { title: 'K칬psignal', desc: 'Pris 칬ver EMA indikerar upp친tg친ende momentum' },
                    { title: 'S칛ljsignal', desc: 'Pris under EMA indikerar ned친tg친ende momentum' },
                    { title: 'F칬rdelar', desc: 'Reagerar snabbare p친 pris칛ndringar 칛n vanlig MA' },
                    { title: 'Period', desc: '50-dagars EMA 칛r popul칛r f칬r medell친nga trender' },
                    { title: 'Anv칛ndning', desc: 'Bra f칬r att f친nga trendf칬r칛ndringar tidigt' }
                ]
            },
            RSI: {
                title: 'Relative Strength Index (RSI)',
                info: [
                    { title: 'Vad 칛r RSI?', desc: 'M칛ter momentum och identifierar 칬verk칬pta/칬vers친lda niv친er (0-100)' },
                    { title: '칐vers친ld', desc: 'RSI < 30 indikerar potentiellt k칬pl칛ge' },
                    { title: '칐verk칬pt', desc: 'RSI > 70 indikerar potentiellt s칛ljl칛ge' },
                    { title: 'Neutral', desc: 'RSI mellan 30-70 칛r normalt omr친de' },
                    { title: 'Divergens', desc: 'N칛r RSI och pris r칬r sig 친t olika h친ll kan det signalera v칛ndning' },
                    { title: 'Tips', desc: 'Anv칛nd tillsammans med trendindikatorer f칬r b칛ttre resultat' }
                ]
            },
            MACD: {
                title: 'MACD (Moving Average Convergence Divergence)',
                info: [
                    { title: 'MACD-linjen', desc: 'Skillnaden mellan 12-dagars och 26-dagars EMA' },
                    { title: 'Signallinjen', desc: '9-dagars EMA av MACD-linjen' },
                    { title: 'Histogram', desc: 'Skillnaden mellan MACD-linjen och signallinjen' },
                    { title: 'K칬psignal', desc: 'N칛r MACD-linjen korsar 칬ver signallinjen' },
                    { title: 'S칛ljsignal', desc: 'N칛r MACD-linjen korsar under signallinjen' },
                    { title: 'Momentum', desc: 'Positivt histogram = upp친tg친ende momentum' }
                ]
            },
            Bollinger: {
                title: 'Bollinger Bands',
                info: [
                    { title: 'Vad 칛r Bollinger Bands?', desc: 'Tre linjer: 칬vre band, mittlinje (SMA), och nedre band' },
                    { title: 'Volatilitet', desc: 'Banden expanderar vid h칬g volatilitet och kontraherar vid l친g' },
                    { title: 'K칬psignal', desc: 'N칛r priset n친r nedre bandet kan det vara k칬pl칛ge' },
                    { title: 'S칛ljsignal', desc: 'N칛r priset n친r 칬vre bandet kan det vara s칛ljl칛ge' },
                    { title: 'Squeeze', desc: 'N칛r banden 칛r smala kan en stor r칬relse vara n칛ra' },
                    { title: 'Tips', desc: 'Kombinera med volym och trendindikatorer' }
                ]
            },
            Stochastic: {
                title: 'Stochastic Oscillator',
                info: [
                    { title: 'Vad 칛r Stochastic?', desc: 'J칛mf칬r st칛ngningspris med prisintervall 칬ver en period (0-100)' },
                    { title: '칐vers친ld', desc: 'V칛rde < 20 indikerar potentiellt k칬pl칛ge' },
                    { title: '칐verk칬pt', desc: 'V칛rde > 80 indikerar potentiellt s칛ljl칛ge' },
                    { title: 'Momentum', desc: 'Visar om k칬pare eller s칛ljare kontrollerar marknaden' },
                    { title: 'Divergens', desc: 'N칛r Stochastic och pris divergerar kan det signalera v칛ndning' },
                    { title: 'Tips', desc: 'Fungerar b칛st i sidledsmarknader, mindre p친litligt i starka trender' }
                ]
            }
        };

        // Get indicator data from sessionStorage
        const indicatorDataStr = sessionStorage.getItem('indicatorData');
        
        if (!indicatorDataStr) {
            document.getElementById('error').textContent = 'Ingen indikator-data hittades. St칛ng denna sida och s칬k p친 en aktie f칬rst.';
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('chart-section').style.display = 'none';
        } else {
            try {
                const data = JSON.parse(indicatorDataStr);
                const indicator = data.indicator;
                const type = data.type;
                const info = indicatorInfo[type];
                
                // Update header
                document.getElementById('indicatorTitle').textContent = `游늳 ${info.title}`;
                document.getElementById('stockName').textContent = `${data.name} (${data.symbol})`;
                document.getElementById('infoTitle').textContent = `Om ${info.title}`;
                
                // Update info grid
                const infoGrid = document.getElementById('infoGrid');
                info.info.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'info-item';
                    div.innerHTML = `<strong>${item.title}</strong>${item.desc}`;
                    infoGrid.appendChild(div);
                });
                
                // Prepare data for chart
                const labels = indicator.timestamps.map(ts => {
                    const date = new Date(ts * 1000);
                    return date.toLocaleDateString('sv-SE', { month: 'short', day: 'numeric' });
                });
                
                // Create chart based on indicator type
                const ctx = document.getElementById('indicatorChart').getContext('2d');
                let chart;
                
                if (type === 'MACD') {
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'MACD-linjen',
                                    data: indicator.macdLine,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Signallinjen',
                                    data: indicator.signalLine,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: 'Histogram',
                                    data: indicator.histogram,
                                    type: 'bar',
                                    backgroundColor: indicator.histogram.map(val => val >= 0 ? 'rgba(76, 175, 80, 0.6)' : 'rgba(244, 67, 54, 0.6)'),
                                    borderColor: indicator.histogram.map(val => val >= 0 ? 'rgb(76, 175, 80)' : 'rgb(244, 67, 54)'),
                                    borderWidth: 1,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: getChartOptions('MACD & Signal', 'Histogram')
                    });
                } else if (type === 'MA' || type === 'EMA') {
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Pris',
                                    data: indicator.prices,
                                    borderColor: 'rgb(54, 162, 235)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: type === 'MA' ? `${indicator.period}-dagars MA` : `${indicator.period}-dagars EMA`,
                                    data: indicator.historical,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: false
                                }
                            ]
                        },
                        options: getChartOptions('Pris & ' + (type === 'MA' ? 'MA' : 'EMA'), data.currency)
                    });
                } else if (type === 'Bollinger') {
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Pris',
                                    data: indicator.prices,
                                    borderColor: 'rgb(54, 162, 235)',
                                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: '칐vre Band',
                                    data: indicator.upper,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    fill: false
                                },
                                {
                                    label: 'Mittlinje (SMA)',
                                    data: indicator.middle,
                                    borderColor: 'rgb(153, 102, 255)',
                                    backgroundColor: 'rgba(153, 102, 255, 0.1)',
                                    borderWidth: 1,
                                    fill: false
                                },
                                {
                                    label: 'Nedre Band',
                                    data: indicator.lower,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    fill: false
                                }
                            ]
                        },
                        options: getChartOptions('Pris & Bollinger Bands', data.currency)
                    });
                } else {
                    // RSI or Stochastic
                    const colors = type === 'RSI' ? 
                        { line: 'rgb(75, 192, 192)', overbought: 'rgb(244, 67, 54)', oversold: 'rgb(76, 175, 80)' } :
                        { line: 'rgb(153, 102, 255)', overbought: 'rgb(244, 67, 54)', oversold: 'rgb(76, 175, 80)' };
                    
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: type === 'RSI' ? 'RSI (14)' : 'Stochastic (14)',
                                    data: indicator.historical,
                                    borderColor: colors.line,
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    borderWidth: 2,
                                    tension: 0.1,
                                    fill: false
                                },
                                {
                                    label: '칐verk칬pt (80)',
                                    data: new Array(labels.length).fill(80),
                                    borderColor: colors.overbought,
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    fill: false,
                                    pointRadius: 0
                                },
                                {
                                    label: '칐vers친ld (20)',
                                    data: new Array(labels.length).fill(20),
                                    borderColor: colors.oversold,
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    fill: false,
                                    pointRadius: 0
                                },
                                ...(type === 'RSI' ? [{
                                    label: '칐verk칬pt (70)',
                                    data: new Array(labels.length).fill(70),
                                    borderColor: colors.overbought,
                                    borderWidth: 1,
                                    borderDash: [2, 2],
                                    fill: false,
                                    pointRadius: 0
                                }, {
                                    label: '칐vers친ld (30)',
                                    data: new Array(labels.length).fill(30),
                                    borderColor: colors.oversold,
                                    borderWidth: 1,
                                    borderDash: [2, 2],
                                    fill: false,
                                    pointRadius: 0
                                }] : [])
                            ]
                        },
                        options: getChartOptions(type === 'RSI' ? 'RSI' : 'Stochastic', 'V칛rde', 0, 100)
                    });
                }
                
            } catch (error) {
                document.getElementById('error').textContent = 'Fel vid laddning av indikator-data: ' + error.message;
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('chart-section').style.display = 'none';
            }
        }

        function getChartOptions(yAxisLabel, currencyOrLabel, min = null, max = null) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: yAxisLabel,
                        font: {
                            size: 18
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (currencyOrLabel && (context.dataset.label === 'Pris' || context.dataset.label.includes('Band') || context.dataset.label.includes('MA') || context.dataset.label.includes('EMA'))) {
                                    label += context.parsed.y.toFixed(2) + ' ' + currencyOrLabel;
                                } else {
                                    label += context.parsed.y.toFixed(4);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Datum'
                        },
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: yAxisLabel
                        },
                        ...(min !== null && max !== null ? { min: min, max: max } : {})
                    },
                    ...(yAxisLabel === 'MACD & Signal' ? {
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Histogram'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    } : {})
                }
            };
        }

        // Clean up sessionStorage when page is closed
        window.addEventListener('beforeunload', () => {
            sessionStorage.removeItem('indicatorData');
        });
    </script>
</body>
</html>
